<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bangladeshi Food Restaurant Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="auth_check.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        color: #333;
      }

      header {
        background: linear-gradient(to right, #e74c3c, #c0392b);
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        font-size: 2rem;
      }

      .logo h1 {
        font-size: 1.8rem;
      }

      .restaurant-info {
        text-align: right;
      }

      .restaurant-info h2 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .restaurant-info p {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 4px;
        transition: background 0.3s;
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .container {
        display: flex;
        min-height: calc(100vh - 80px);
      }

      .sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 1.5rem 1rem;
      }

      .sidebar ul {
        list-style: none;
      }

      .sidebar li {
        margin-bottom: 10px;
      }

      .sidebar a {
        color: white;
        text-decoration: none;
        display: block;
        padding: 10px 15px;
        border-radius: 5px;
        transition: background 0.3s;
      }

      .sidebar a:hover,
      .sidebar a.active {
        background-color: #34495e;
      }

      .sidebar i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
      }

      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .card i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: #e74c3c;
      }

      .card h3 {
        font-size: 1.8rem;
        margin-bottom: 5px;
      }

      .card p {
        color: #777;
      }

      .section {
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .section-header h2 {
        color: #2c3e50;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #f8f9fa;
        color: #2c3e50;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .status-pending {
        background-color: #fff3cd;
        color: #856404;
      }

      .status-preparing {
        background-color: #d1ecf1;
        color: #0c5460;
      }

      .status-ready {
        background-color: #d4edda;
        color: #155724;
      }

      .status-delivered {
        background-color: #d1e7dd;
        color: #0f5132;
      }

      .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      .btn-primary {
        background-color: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background-color: #2980b9;
      }

      .btn-success {
        background-color: #2ecc71;
        color: white;
      }

      .btn-success:hover {
        background-color: #27ae60;
      }

      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c0392b;
      }

      .menu-item {
        display: flex;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .menu-item:last-child {
        border-bottom: none;
      }

      .menu-item-img {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 20px;
      }

      .menu-item-details {
        flex: 1;
      }

      .menu-item-details h3 {
        margin-bottom: 5px;
      }

      .menu-item-details p {
        color: #777;
        margin-bottom: 10px;
      }

      .menu-item-price {
        font-weight: bold;
        color: #e74c3c;
        font-size: 1.2rem;
      }

      .menu-item-actions {
        display: flex;
        gap: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error {
        color: #e74c3c;
        text-align: center;
        padding: 20px;
      }

      footer {
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 1rem;
        margin-top: 30px;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
        }

        .dashboard-cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <i class="fas fa-utensils"></i>
        <h1>BanglaFood Restaurant</h1>
      </div>
      <div class="nav-links">
        <a href="index.html">View Customer Site</a>
      </div>
      <div class="restaurant-info">
        <h2>Bengali Traditional Food</h2>
        <p>Restaurant ID: RES-2023-001</p>
        <a
          href="logout.php"
          style="color: white; text-decoration: none; font-size: 0.9rem"
        >
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </header>

    <div class="container">
      <nav class="sidebar">
        <ul>
          <li>
            <a href="#" class="active"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="#" onclick="loadOrders()"
              ><i class="fas fa-list-alt"></i> Orders</a
            >
          </li>
          <li>
            <a href="#" onclick="loadMenuItems()"
              ><i class="fas fa-utensils"></i> Menu</a
            >
          </li>
        </ul>
      </nav>

      <main class="main-content">
        <div class="dashboard-cards">
          <div class="card">
            <i class="fas fa-shopping-cart"></i>
            <h3 id="newOrders">0</h3>
            <p>New Orders Today</p>
          </div>
          <div class="card">
            <i class="fas fa-utensils"></i>
            <h3 id="preparingOrders">0</h3>
            <p>Preparing</p>
          </div>
          <div class="card">
            <i class="fas fa-motorcycle"></i>
            <h3 id="deliveryOrders">0</h3>
            <p>Out for Delivery</p>
          </div>
          <div class="card">
            <i class="fas fa-dollar-sign"></i>
            <h3 id="todayRevenue">à§³0</h3>
            <p>Today's Revenue</p>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Recent Orders</h2>
            <button class="btn btn-primary" onclick="loadOrders()">
              Refresh Orders
            </button>
          </div>
          <div id="ordersTable">
            <div class="loading" id="ordersLoading">Loading orders...</div>
            <table style="display: none" id="ordersTableElement">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="ordersBody"></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Menu Management</h2>
            <button class="btn btn-primary" onclick="loadMenuItems()">
              Refresh Menu
            </button>
          </div>
          <div id="menuItems">
            <div class="loading">Loading menu items...</div>
          </div>
        </div>
      </main>
    </div>

    <footer>
      <p>BanglaFood Restaurant Portal &copy; 2023 | University Project</p>
    </footer>

    <script>
      // Load orders from database
      function loadOrders() {
        console.log("Loading orders...");
        document.getElementById("ordersLoading").style.display = "block";
        document.getElementById("ordersTableElement").style.display = "none";

        fetch("api/get_orders.php")
          .then((response) => {
            console.log("Orders response status:", response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((orders) => {
            console.log("Orders received:", orders);
            document.getElementById("ordersLoading").style.display = "none";
            document.getElementById("ordersTableElement").style.display =
              "table";

            const ordersBody = document.getElementById("ordersBody");
            ordersBody.innerHTML = "";

            let newOrders = 0;
            let preparingOrders = 0;
            let deliveryOrders = 0;
            let todayRevenue = 0;

            if (orders && orders.length === 0) {
              ordersBody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 20px;">No orders found</td></tr>';
            } else if (orders && orders.length > 0) {
              orders.forEach((order) => {
                const row = document.createElement("tr");

                // Format order items
                const itemsText = order.items || "No items";

                // Determine status and count
                let statusClass, statusText, actionButton;
                switch (order.status) {
                  case "pending":
                    statusClass = "status-pending";
                    statusText = "Pending";
                    actionButton = `<button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'confirmed')">Accept</button>`;
                    newOrders++;
                    break;
                  case "confirmed":
                    statusClass = "status-preparing";
                    statusText = "Preparing";
                    actionButton = `<button class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'preparing')">Ready</button>`;
                    preparingOrders++;
                    break;
                  case "preparing":
                    statusClass = "status-ready";
                    statusText = "Ready";
                    actionButton = `<button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'delivered')">Dispatch</button>`;
                    preparingOrders++;
                    break;
                  case "delivered":
                    statusClass = "status-delivered";
                    statusText = "Delivered";
                    actionButton = `<button class="btn btn-primary">Details</button>`;
                    deliveryOrders++;
                    break;
                  default:
                    statusClass = "status-pending";
                    statusText = "Pending";
                    actionButton = `<button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'confirmed')">Accept</button>`;
                    newOrders++;
                }

                // Add to today's revenue if order is from today
                if (order.created_at) {
                  const orderDate = new Date(order.created_at);
                  const today = new Date();
                  if (orderDate.toDateString() === today.toDateString()) {
                    todayRevenue += parseFloat(order.total_amount) || 0;
                  }
                }

                row.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${order.customer_name || "N/A"}</td>
                        <td>${itemsText}</td>
                        <td>à§³${order.total_amount || "0"}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${actionButton}</td>
                    `;
                ordersBody.appendChild(row);
              });
            } else {
              ordersBody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 20px;">No orders data available</td></tr>';
            }

            // Update dashboard cards
            document.getElementById("newOrders").textContent = newOrders;
            document.getElementById("preparingOrders").textContent =
              preparingOrders;
            document.getElementById("deliveryOrders").textContent =
              deliveryOrders;
            document.getElementById(
              "todayRevenue"
            ).textContent = `à§³${todayRevenue}`;
          })
          .catch((error) => {
            console.error("Error loading orders:", error);
            document.getElementById("ordersLoading").innerHTML =
              '<div class="error">Error loading orders: ' +
              error.message +
              "</div>";
          });
      }

      // Load menu items
      function loadMenuItems() {
        console.log("Loading menu items...");

        fetch("api/get_foods.php")
          .then((response) => {
            console.log("Foods response status:", response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((foods) => {
            console.log("Foods received:", foods);
            const menuItemsContainer = document.getElementById("menuItems");

            if (foods && foods.length === 0) {
              menuItemsContainer.innerHTML =
                '<div class="loading">No menu items found in database</div>';
              return;
            }

            if (foods && foods.length > 0) {
              menuItemsContainer.innerHTML = "";

              foods.forEach((food) => {
                const menuItem = document.createElement("div");
                menuItem.className = "menu-item";
                menuItem.innerHTML = `
                        <div class="menu-item-img" style="background-color: ${
                          food.image_color || "#ddd"
                        }; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${food.name}
                        </div>
                        <div class="menu-item-details">
                            <h3>${food.name}</h3>
                            <p>${
                              food.description || "No description available"
                            }</p>
                            <div class="menu-item-price">à§³${food.price}</div>
                        </div>
                        <div class="menu-item-actions">
                            <button class="btn btn-primary">Edit</button>
                            <button class="btn btn-danger">Remove</button>
                        </div>
                    `;
                menuItemsContainer.appendChild(menuItem);
              });
            } else {
              menuItemsContainer.innerHTML =
                '<div class="error">No menu data available</div>';
            }
          })
          .catch((error) => {
            console.error("Error loading menu items:", error);
            document.getElementById("menuItems").innerHTML =
              '<div class="error">Error loading menu items: ' +
              error.message +
              "</div>";
          });
      }

      // Update order status
      function updateOrderStatus(orderId, newStatus) {
        fetch("api/update_order.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            order_id: orderId,
            status: newStatus,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(`Order #${orderId} status updated to ${newStatus}`);
              loadOrders(); // Refresh the orders list
            } else {
              alert("Error updating order: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error updating order status: " + error.message);
          });
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded, initializing...");
        loadOrders();
        loadMenuItems();

        // Auto-refresh orders every 30 seconds
        setInterval(loadOrders, 30000);
      });
    </script>
  </body>
</html>
